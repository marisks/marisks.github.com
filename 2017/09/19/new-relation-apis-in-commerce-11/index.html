<!DOCTYPE html><!--if lt IE 8html.no-js.lt-ie9.lt-ie8(lang="en")--><!--if IE 8html.no-js.lt-ie9(lang="en")--><!--if gt IE 8html.no-js(lang="en")--><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>New relation APIs in Episerver Commerce 11 | marisks # code</title><meta name="description" content="Recently, Episerver has changed relation APIs. Now those are easier to understand and use."><meta name="keywords" content=".NET, ASP.NET, C#, JavaScript, Optimizely, EPiServer, programming languages"><meta name="viewport" content="width=device-width, initial-scale=1"><!--Place favicon.ico and apple-touch-icon.png in the root directory--><meta name="generator" content="DocPad v6.79.4" /><!-- Google Tag Manager--><script async src="https://www.googletagmanager.com/gtag/js?id=G-540M01NJGH"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-540M01NJGH');</script><!-- End Google Tag Manager--><link rel="icon" sizes="16x16 32x32" href="/favicon.ico?v=1"><link  rel="stylesheet" href="/css/vendor/normalize.css" /><link  rel="stylesheet" href="/css/vendor/main.css" /><link  rel="stylesheet" href="/css/vendor/bootstrap.min.css" /><link  rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" /><link  rel="stylesheet" href="/css/style.css" /><script src="/js/vendor/modernizr-2.6.2.min.js"></script></head><body><!-- Google Tag Manager--><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-WDKMR7" height="0" width="0" style="display: none; visibility: hidden;"></iframe></noscript><!-- End Google Tag Manager--><!--if lt IE 8p.browsehappy
    |You are using an
    strong
        |outdated browser
    |. Please
    a(href="http://browsehappy.com/")
        |upgrade your browser
    |to improve your experience.
--><div id="wrap"><div role="navigation" class="navbar navbar-ornament navbar-fixed-top"><div class="container"><div class="navbar-header"><a href="/" class="navbar-brand">marisks # code</a></div></div></div><div class="container"><div class="row"><div class="col-sm-8"><article><header><h1>New relation APIs in Episerver Commerce 11</h1><p class="meta"><time datetime="2017-09-19T00:00:00.000Z">Tue Sep 19 2017</time></p></header><div class="lead"><p>Recently, Episerver has changed relation APIs. Now those are easier to understand and use.</p>

</div><p>The first change you will notice when working with new relations is that now it uses Parent/Child properties instead of Source/Target ones. It makes the code easier to understand. Here is how it looks like for different relations:</p>
<ul>
<li><em>ProductVariation</em> - the parent property has a reference to a product and the child property has a reference to a variation of this product.</li>
<li><em>PackageEntry</em> and <em>BundleEntry</em> - the parent property has a reference to a package or a bundle and the child property has a reference to a product which is within the package or the bundle.</li>
<li><em>NodeRelation</em> - the parent property has a reference to a category and the child property has a reference to a product or a sub-category which are under the <em>parent</em> category.</li>
</ul>
<p>In <em>Commerce 11</em>, <em>Episerver</em> had made more internal changes to the relations. One important change is related to URL creation for catalog contents. Previously <em>Episerver</em> used <em>ParentLink</em> on the catalog item to find all parents of it and build URL like <a href="http://mysite.com/root/parent1/parent2/product">http://mysite.com/root/parent1/parent2/product</a>. But now it uses relations instead. Now category/product (node) relation is used to build URLs. But as there might be multiple category/product relations for each item, there is a special relation - the primary relation. Until the <em>Commerce 11.2</em>, there was no easy way to find out which relation is primary. It was created automatically on catalog item creation or moving. <strong>While it was a special relation, you could find it with <em>IRelationRepository.GetParents&lt;NodeRelation&gt;(ContentReference link)</em> or <em>IRelationRepository.GetChildren&lt;NodeRelation&gt;(ContentReference link)</em> and delete it with <em>IRelationRepository.RemoveRelation(NodeRelation relation)</em>. And there was no way how to get it back.</strong></p>
<p><em>Episerver</em> has added a new relation type in <em>Commerce 11.2</em> which solves this issue - <em>NodeEntryRelation</em>. This relation has a property <em>IsPrimary</em> which allows you to distinguish primary relations from other ones. You should not use the old <em>NodeRelation</em> now but use <em>NodeEntryRelation</em> instead. Now you can find relations which are and are not primary and even if you remove the primary relation, you can get it back by creating the new one.</p>
<p>Now you can get children of the parent category like this:</p>
<pre><code class="lang-charp">var children = _relationRepository.GetChildren&lt;NodeEntryRelation&gt;(parentLink);
</code></pre>
<p>And if you want to remove all related categories except the primary category for the item:</p>
<pre><code class="lang-charp">var parents =
    _relationRepository
        .GetParents&lt;NodeEntryRelation&gt;(childLink)
        .Where(x =&gt; !x.IsPrimary);
_relationRepository.RemoveRelations(parents);
</code></pre>
<p>Another improvement all relation types have is sorting. Now each relation has a <em>SortOrder</em> property. You can use it to order the items as you want. You can set this property from the code, or you can sort products from the UI (category sorting not supported yet), and it will be updated.</p>
<h1 id="summary">Summary</h1>
<p>I think that the issue with <em>NodeRelation</em> and primary categories could be omitted if primary node relations would not be listed in <em>GetParents</em> or <em>GetChildren</em> methods. This way it would remain as an internal API. And if the developer would want to change the primary category, he could still use the <em>ParentLink</em> property of an item.</p>
<p>Anyway, <em>Episerver</em> has done a lot of useful improvements in the relation APIs. While there were some issues with it in early <em>Commerce 11</em> versions, now those are fixed with new <em>NodeEntryRelation</em>.</p>
</article><div id="disqus_thread"></div><script>/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'marisksblog'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a><a href="http://disqus.com" class="dsq-brlink">comments powered by<span class="logo-disqus">Disqus</span></a></noscript></div><div class="col-sm-1"><aside class="archive"><ul class="nav"><li><a href="/">2021</a></li><li><a href="/2020/">2020</a></li><li><a href="/2019/">2019</a></li><li><a href="/2018/">2018</a></li><li class="active"><a href="/2017/">2017</a></li><li><a href="/2016/">2016</a></li><li><a href="/2015/">2015</a></li><li><a href="/2014/">2014</a></li><li><a href="/2013/">2013</a></li><li><a href="/2012/">2012</a></li></ul></aside></div><div class="col-sm-3"><aside class="panel panel-default"><div class="panel-body"><div class="about"><img src="/img/common/profile_0021.jpg" alt="profile picture" class="center-block img-responsive thumbnail"><p>Hi! I'm Māris Krivtežs. I am Web developer primarily working with ASP.NET, EPiServer and front-end development at&nbsp;<a href="http://geta.no" target="_blank">Geta</a>, but same time learning different programming languages, learning new programming paradigms, architectures, and design. I spend my free time with my family, reading books, bicycling and traveling.</p></div><ul class="social"><li><a href="http://stackoverflow.com/users/660154/marisks" target="_blank"><i class="fa fa-stack-overflow"></i></a></li><li><a href="https://github.com/marisks" target="_blank"><i class="fa fa-github-alt"></i></a></li><li><a href="https://twitter.com/pioners1001" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="http://www.linkedin.com/pub/maris-krivtezs/31/98b/b53" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="/rss.xml" target="_blank"><i class="fa fa-rss"></i></a></li></ul><a href="https://getadigital.com" target="_blank"><img src="/img/common/ident-geta-wordmark.svg" alt="Geta logo" class="center-block img-responsive aside-logo"></a></div></aside></div></div></div></div><div id="footer"><div class="container"><div class="container credit">Copyright &copy; 2017 Maris Krivtezs. All Rights Reserved, except for the parts enumerated below:<ul class="licence-list"><li>- The source code examples on this blog are covered by&nbsp;<a href="https://opensource.org/licenses/mit-license.php">MIT License</a>.</li><li>- This page content, excluding the visual design and the logotype, is covered by&nbsp;<a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</li></ul></div></div></div><script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script>window.jQuery || document.write('<script src="/js/vendor/jquery-1.10.2.min.js"><\/script>')</script><script  src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script><script  src="/js/plugins.js"></script><script  src="/js/main.js"></script></body>